<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Realtime</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(120deg,#f3e8ff,#e0f7ff);
  padding: 20px;
}
h1 { text-align:center; color:#4b0082 }
table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff }
th,td { border:1px solid #d6bcfa; padding:5px; text-align:center }
th { background:#6b21a8; color:#fff }
input,select { border:1px solid #a78bfa; border-radius:4px; padding:4px }
button { margin-top:10px; padding:6px 12px; background:#06b6d4; color:#fff; border:none; border-radius:5px; cursor:pointer }
button:hover { background:#0891b2 }
button.danger { background:#dc2626 }
.total { font-weight:bold }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<h1>ðŸ“‹ Planilha Realtime</h1>

<label>Colaborador:</label>
<select id="colaboradorSelect" onchange="trocarColaborador()"></select>

<label style="margin-left:20px;">MÃªs:</label>
<select id="mesSelect" onchange="trocarMes()"></select>
<button onclick="novoMes()">ðŸ“† Novo mÃªs</button>

<table>
<thead>
<tr>
  <th>Aluno</th>
  <th>Tipo</th>
  <th>Base</th>
  <th>Extra</th>
  <script>for(let i=1;i<=31;i++)document.write(`<th>${i}</th>`)</script>
  <th>Total</th>
</tr>
</thead>
<tbody id="corpoTabela"></tbody>
</table>

<button onclick="adicionarAluno()">âž• Aluno</button>
<button onclick="limparChecks()">ðŸ§¹ Limpar quadradinhos</button>

<p id="total"></p>
<p id="media"></p>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD9Er27RZlKcFVVwrnWfo2xvWkPUla9JRs",
  authDomain: "colaboradores-5a2a2.firebaseapp.com",
  databaseURL: "https://colaboradores-5a2a2-default-rtdb.firebaseio.com",
  projectId: "colaboradores-5a2a2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let colaboradorAtual=null, mesAtual=null, suspendSave=false;

/* ================= COLABORADORES ================= */

function carregarColaboradores(){
  db.ref("colaboradores").once("value", snap=>{
    colaboradorSelect.innerHTML="";
    Object.keys(snap.val()||{}).forEach(n=>{
      let o=document.createElement("option");
      o.value=o.textContent=n;
      colaboradorSelect.appendChild(o);
    });
    colaboradorAtual = colaboradorSelect.value;
    carregarMeses();
  });
}

function trocarColaborador(){
  colaboradorAtual = colaboradorSelect.value;
  carregarMeses();
}

/* ================= MESES (COMPATÃVEL COM DADOS ANTIGOS) ================= */

function carregarMeses(){
  mesSelect.innerHTML="";
  db.ref(`colaboradores/${colaboradorAtual}`).once("value", snap=>{
    const dados = snap.val()||{};

    // ðŸ”„ se ainda for formato antigo
    if(dados.alunos && !dados.meses){
      const mesPadrao = new Date().toISOString().slice(0,7);
      db.ref(`colaboradores/${colaboradorAtual}/meses/${mesPadrao}`)
        .set({ alunos: dados.alunos });
      db.ref(`colaboradores/${colaboradorAtual}/alunos`).remove();
      dados.meses = { [mesPadrao]: { alunos:dados.alunos } };
    }

    Object.keys(dados.meses||{}).sort().forEach(m=>{
      let o=document.createElement("option");
      o.value=o.textContent=m;
      mesSelect.appendChild(o);
    });

    mesAtual = mesSelect.value;
    carregarDados();
    calcularMedia();
  });
}

function trocarMes(){
  mesAtual = mesSelect.value;
  carregarDados();
}

function novoMes(){
  let mes = prompt("MÃªs (ex: 2025-02)");
  if(!mes) return;

  db.ref(`colaboradores/${colaboradorAtual}/meses/${mes}`).set({ alunos:[] });
  mesAtual = mes;
  carregarMeses();
}

/* ================= DADOS ================= */

function carregarDados(){
  db.ref(`colaboradores/${colaboradorAtual}/meses/${mesAtual}`).once("value", snap=>{
    suspendSave=true;
    corpoTabela.innerHTML="";
    (snap.val()?.alunos||[]).forEach(a=>adicionarAluno(a,true));
    calcularTotal();
    suspendSave=false;
  });
}

function adicionarAluno(d=null, remoto=false){
  let tr=document.createElement("tr");
  tr.innerHTML=`
<td><input class="nome"></td>
<td><select class="tipo"><option>Mensal</option><option>Gympass</option><option>TotalPass</option></select></td>
<td><input class="base" type="number"></td>
<td><input class="extra" type="number"></td>
${"<td><input type='checkbox'></td>".repeat(31)}
<td class="total">0</td>`;
  corpoTabela.appendChild(tr);

  if(d){
    tr.querySelector(".nome").value=d.nome||"";
    tr.querySelector(".tipo").value=d.tipo||"Mensal";
    tr.querySelector(".base").value=d.valorBase||"";
    tr.querySelector(".extra").value=d.valorExtra||"";
    d.dias?.forEach((x,i)=>tr.querySelectorAll("input[type=checkbox]")[i].checked=x);
  }

  tr.querySelectorAll("input,select").forEach(e=>e.onchange=()=>{salvar();calcularTotal()});
  if(!remoto) salvar();
}

function limparChecks(){
  document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
  salvar(); calcularTotal();
}

/* ================= SALVAR / TOTAIS ================= */

function salvar(){
  if(suspendSave) return;
  let alunos=[];
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    alunos.push({
      nome: tr.querySelector(".nome").value,
      tipo: tr.querySelector(".tipo").value,
      valorBase: tr.querySelector(".base").value,
      valorExtra: tr.querySelector(".extra").value,
      dias:[...tr.querySelectorAll("input[type=checkbox]")].map(c=>c.checked)
    });
  });
  db.ref(`colaboradores/${colaboradorAtual}/meses/${mesAtual}`).set({ alunos });
}

function calcularTotal(){
  let total=0;
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    let b=+tr.querySelector(".base").value||0;
    let e=+tr.querySelector(".extra").value||0;
    let d=tr.querySelectorAll("input[type=checkbox]:checked").length;
    let t=b*d+e;
    tr.querySelector(".total").innerText=t.toFixed(2);
    total+=t;
  });
  document.getElementById("total").innerText="Total do mÃªs: R$ "+total.toFixed(2);
}

function calcularMedia(){
  db.ref(`colaboradores/${colaboradorAtual}/meses`).once("value", snap=>{
    let soma=0,qtd=0;
    Object.values(snap.val()||{}).forEach(m=>{
      let t=0;
      (m.alunos||[]).forEach(a=>{
        let d=(a.dias||[]).filter(x=>x).length;
        t+=(+a.valorBase||0)*d+(+a.valorExtra||0);
      });
      soma+=t; qtd++;
    });
    document.getElementById("media").innerText =
      qtd ? "MÃ©dia salarial: R$ "+(soma/qtd).toFixed(2) : "";
  });
}

window.onload=carregarColaboradores;
</script>

</body>
</html>

