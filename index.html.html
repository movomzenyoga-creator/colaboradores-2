<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Autom√°tica - M√∫ltiplos Colaboradores (Realtime) - Migrado</title>

<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 40px;
    background: linear-gradient(120deg, #f3e8ff, #e0f7ff);
    color: #333;
  }
  h1 {
    text-align: center;
    color: #4b0082;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    font-size: 14px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    border: 1px solid #d6bcfa;
    padding: 6px;
    text-align: center;
  }
  th {
    background: #6b21a8;
    color: white;
  }
  tr:nth-child(even) { background: #faf5ff; }
  tr:nth-child(odd) { background: #ffffff; }
  input, select {
    padding: 4px;
    border: 1px solid #a78bfa;
    border-radius: 4px;
  }
  button {
    margin-top: 15px;
    padding: 8px 16px;
    background: #06b6d4;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover { background: #0891b2; }
  #total {
    margin-top: 15px;
    font-weight: bold;
    color: #4b0082;
  }
  #colaboradorSelect {
    margin-right: 8px;
    border: 1px solid #a78bfa;
    border-radius: 4px;
  }
  #periodo {
    font-weight: bold;
    color: #4b0082;
  }
  .periodo-container {
    margin-bottom: 20px;
    text-align: center;
  }
</style>

<!-- XLSX para exportar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase compat (usa firebase.initializeApp e firebase.database compat√≠vel com o exemplo) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

</head>
<body>

<h1>üìã Planilha de Alunos e Colaboradores (Realtime) ‚Äî Migra√ß√£o autom√°tica</h1>

<div class="periodo-container">
  <label for="mesInput"><b>Selecionar M√™s:</b></label>
  <input type="month" id="mesInput">
  <button onclick="salvarPeriodo()">Salvar Per√≠odo</button>
  <p id="periodo"></p>
</div>

<label>Colaborador: </label>
<select id="colaboradorSelect" onchange="trocarColaborador()"></select>
<button onclick="novoColaborador()">‚ûï Novo Colaborador</button>
<button onclick="removerColaborador()">üóëÔ∏è Remover Colaborador</button>

<br><br>

<table id="planilha">
  <thead>
    <tr>
      <th>Aluno</th>
      <th>Modalidade</th>
      <th>Tipo</th>
      <th>Valor Base (R$)</th>
      <th>Valor Extra (R$)</th>
      <!-- dias 1..31 -->
      <script>
        for(let i=1; i<=31; i++){
          document.write(`<th>${i}</th>`);
        }
      </script>
      <th>Total</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="corpoTabela"></tbody>
</table>

<button onclick="adicionarAluno()">‚ûï Adicionar Aluno</button>
<button onclick="calcularTotal()">üí∞ Calcular Total</button>
<button onclick="limparQuadradinhos()">üßπ Limpar Quadradinhos</button>
<button onclick="exportarExcel()">üìÅ Exportar para Excel</button>

<p id="total"></p>

<script>
/* ============================
   CONFIGURA√á√ÉO FIREBASE (suas credenciais)
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyD9Er27RZlKcFVVwrnWfo2xvWkPUla9JRs",
  authDomain: "colaboradores-5a2a2.firebaseapp.com",
  databaseURL: "https://colaboradores-5a2a2-default-rtdb.firebaseio.com",
  projectId: "colaboradores-5a2a2",
  storageBucket: "colaboradores-5a2a2.firebasestorage.app",
  messagingSenderId: "84321823380",
  appId: "1:84321823380:web:4b962179789fff019aa281"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================
   VARI√ÅVEIS GLOBAIS
   ============================ */
let corpoTabela = document.getElementById("corpoTabela");
let colaboradorAtual = null;
let colaboradoresLista = [];
let suspendSave = false;
let colListenerName = null;
let globalListener = null;
let saveTimeout = null;

/* ============================
   MIGRA√á√ÉO AUTOM√ÅTICA (localStorage -> Firebase)
   ============================ */
async function migrarLocalParaFirebaseSeNecessario() {
  try {
    // verifica flag para n√£o repetir migra√ß√£o
    if (localStorage.getItem("migratedToFirebase") === "1") return;

    const localRaw = localStorage.getItem("planilhaMulti");
    if (!localRaw) {
      // nada para migrar
      localStorage.setItem("migratedToFirebase", "1");
      return;
    }

    let localData;
    try {
      localData = JSON.parse(localRaw);
    } catch (e) {
      console.warn("Erro ao parsear planilhaMulti do localStorage:", e);
      localStorage.setItem("migratedToFirebase", "1");
      return;
    }

    // pega periodo salvo local como fallback
    const periodoLocal = localStorage.getItem("periodoSelecionado") || "";

    // l√™ snapshot atual do DB
    const snapshot = await db.ref("colaboradores").once("value");
    const dbData = snapshot.val();

    // se DB vazio, simplesmente grava tudo (mapeando estrutura)
    if (!dbData || Object.keys(dbData).length === 0) {
      const toWrite = {};
      for (const nome in localData) {
        if (!localData.hasOwnProperty(nome)) continue;
        const node = localData[nome] || {};
        toWrite[nome] = {
          alunos: node.alunos || [],
          periodoSelecionado: periodoLocal
        };
      }
      if (Object.keys(toWrite).length > 0) {
        suspendSave = true;
        await db.ref("colaboradores").set(toWrite);
        suspendSave = false;
      }
      localStorage.setItem("migratedToFirebase", "1");
      return;
    }

    // DB j√° possui dados -> fazemos merge inteligente
    // Para cada colaborador local:
    //  - se n√£o existe no DB -> adiciona
    //  - se existe e DB.alunos vazio -> copia os alunos locais
    //  - caso contr√°rio N√ÉO sobrescreve
    const updates = {};
    for (const nome in localData) {
      if (!localData.hasOwnProperty(nome)) continue;
      const localNode = localData[nome] || {};
      const dbNode = dbData[nome];

      if (!dbNode) {
        updates[nome] = {
          alunos: localNode.alunos || [],
          periodoSelecionado: periodoLocal
        };
      } else {
        // existe no db
        const dbAlunos = dbNode.alunos;
        if ((!dbAlunos || dbAlunos.length === 0) && (localNode.alunos && localNode.alunos.length > 0)) {
          updates[nome + "/alunos"] = localNode.alunos;
        }
        if ((!dbNode.periodoSelecionado || dbNode.periodoSelecionado === "") && periodoLocal) {
          updates[nome + "/periodoSelecionado"] = periodoLocal;
        }
      }
    }

    if (Object.keys(updates).length > 0) {
      // aplica updates (usando update para mesclar)
      suspendSave = true;
      await db.ref("colaboradores").update(updates);
      suspendSave = false;
    }

    // marca como migrado
    localStorage.setItem("migratedToFirebase", "1");
    console.log("Migra√ß√£o local->Firebase conclu√≠da (se havia dados).");
  } catch (err) {
    console.error("Erro na migra√ß√£o local->Firebase:", err);
    // n√£o setamos flag para permitir nova tentativa no pr√≥ximo carregamento
  }
}

/* ============================
   PER√çODO
   ============================ */
function atualizarPeriodoTexto(mesSelecionado) {
  if (!mesSelecionado) {
    document.getElementById("periodo").innerText = "";
    return;
  }
  let [ano, mes] = mesSelecionado.split("-");
  mes = Number(mes) - 1;
  let inicio = new Date(ano, mes, 5);
  let fim = new Date(ano, mes + 1, 4);
  let opcoes = { month: 'short' };
  document.getElementById("periodo").innerText =
    `Per√≠odo: ${inicio.getDate()}/${inicio.toLocaleDateString('pt-BR', opcoes)} a ${fim.getDate()}/${fim.toLocaleDateString('pt-BR', opcoes)}`;
}

async function carregarPeriodo() {
  let salvo = localStorage.getItem("periodoSelecionado");
  let mesInput = document.getElementById("mesInput");
  if (salvo) {
    mesInput.value = salvo;
    atualizarPeriodoTexto(salvo);
  } else {
    let hoje = new Date();
    let mes = (hoje.getMonth() + 1).toString().padStart(2, "0");
    let ano = hoje.getFullYear();
    mesInput.value = `${ano}-${mes}`;
    salvarPeriodo();
  }
}

async function salvarPeriodo() {
  let mesSelecionado = document.getElementById("mesInput").value;
  if (!mesSelecionado) return;
  localStorage.setItem("periodoSelecionado", mesSelecionado);
  atualizarPeriodoTexto(mesSelecionado);

  if (!colaboradorAtual) return;
  try {
    suspendSave = true;
    await db.ref("colaboradores/" + colaboradorAtual + "/periodoSelecionado").set(mesSelecionado);
  } finally {
    setTimeout(()=> suspendSave = false, 50);
  }
}

/* ============================
   LISTENERS GLOBAIS E DO COLABORADOR
   ============================ */
function attachGlobalListener() {
  const ref = db.ref("colaboradores");
  if (globalListener) ref.off("value", globalListener);
  globalListener = ref.on("value", snapshot => {
    const val = snapshot.val() || {};
    colaboradoresLista = Object.keys(val);
    if (colaboradoresLista.length === 0) {
      // cria um colaborador padr√£o se necess√°rio
      db.ref("colaboradores/Colaborador 1").set({ alunos: [], periodoSelecionado: document.getElementById("mesInput").value || "" });
      return;
    }
    atualizarSelectColaboradores();
  });
}

function atualizarSelectColaboradores() {
  const select = document.getElementById("colaboradorSelect");
  const antiga = select.value;
  select.innerHTML = "";
  colaboradoresLista.forEach(nome => {
    let opt = document.createElement("option");
    opt.value = nome;
    opt.textContent = nome;
    select.appendChild(opt);
  });
  if (colaboradoresLista.includes(colaboradorAtual)) {
    select.value = colaboradorAtual;
  } else if (antiga && colaboradoresLista.includes(antiga)) {
    colaboradorAtual = antiga;
    select.value = colaboradorAtual;
  } else {
    colaboradorAtual = colaboradoresLista[0];
    select.value = colaboradorAtual;
  }
  attachColaboradorListener(colaboradorAtual);
}

function attachColaboradorListener(nomeColab) {
  if (!nomeColab) return;
  // remove listener antigo
  if (colListenerName) {
    db.ref("colaboradores/" + colListenerName).off("value");
    colListenerName = null;
  }
  const path = "colaboradores/" + nomeColab;
  colListenerName = nomeColab;
  db.ref(path).on("value", snapshot => {
    const data = snapshot.val() || { alunos: [], periodoSelecionado: null };
    aplicarDadosRemotos(data);
  });
}

/* ============================
   APLICAR DADOS REMOTOS NA UI
   ============================ */
function aplicarDadosRemotos(data) {
  try {
    suspendSave = true;
    corpoTabela.innerHTML = "";
    if (data.alunos && Array.isArray(data.alunos)) {
      data.alunos.forEach(a => adicionarAluno(a, true));
    }
    if (data.periodoSelecionado) {
      document.getElementById("mesInput").value = data.periodoSelecionado;
      atualizarPeriodoTexto(data.periodoSelecionado);
      localStorage.setItem("periodoSelecionado", data.periodoSelecionado);
    }
    calcularTotal();
  } finally {
    setTimeout(()=> suspendSave = false, 60);
  }
}

/* ============================
   FUN√á√ïES DE CRUD LOCAIS (UI)
   ============================ */
function novoColaborador() {
  let nome = prompt("Digite o nome do novo colaborador:");
  if (!nome) return;
  db.ref("colaboradores/" + nome).set({
    alunos: [],
    periodoSelecionado: document.getElementById("mesInput").value || ""
  });
  colaboradorAtual = nome;
}

function removerColaborador() {
  if (!colaboradorAtual) return;
  if (!confirm(`Remover ${colaboradorAtual} e todos os dados dele?`)) return;
  db.ref("colaboradores/" + colaboradorAtual).remove();
  colaboradorAtual = null;
}

function trocarColaborador() {
  const sel = document.getElementById("colaboradorSelect");
  const novo = sel.value;
  if (!novo) return;
  colaboradorAtual = novo;
  attachColaboradorListener(colaboradorAtual);
}

/* ============================
   LINHAS / ALUNOS
   ============================ */
function adicionarAluno(alunoData = null, isRemote=false) {
  let linha = document.createElement("tr");
  linha.innerHTML = `
    <td><input type="text" placeholder="Nome do aluno"></td>
    <td>
      <select>
        <option value="Yoga">Yoga</option>
        <option value="Pilates">Pilates</option>
      </select>
    </td>
    <td>
      <select class="tipoSelect">
        <option value="Mensal">Mensal</option>
        <option value="Gympass">Gympass</option>
        <option value="TotalPass">TotalPass</option>
      </select>
    </td>
    <td><input type="number" placeholder="Valor base" min="0" step="0.01"></td>
    <td><input type="number" placeholder="Valor extra" min="0" step="0.01"></td>
    ${Array.from({length: 31}, () => '<td><input type="checkbox"></td>').join('')}
    <td class="total">0</td>
    <td>
      <button class="removerBtn">‚ùå</button>
      <button class="limparBtn">üßΩ</button>
    </td>
  `;
  corpoTabela.appendChild(linha);

  if (alunoData) {
    let inputs = linha.querySelectorAll('input, select');
    inputs[0].value = alunoData.nome || "";
    inputs[1].value = alunoData.modalidade || "Yoga";
    inputs[2].value = alunoData.tipo || "Mensal";
    inputs[3].value = alunoData.valorBase || 0;
    inputs[4].value = alunoData.valorExtra || 0;
    const dias = Array.isArray(alunoData.dias) ? alunoData.dias : [];
    for (let i = 0; i < 31; i++) {
      const cb = inputs[5 + i];
      if (cb && typeof dias[i] !== "undefined") cb.checked = !!dias[i];
    }
  }

  const allInputs = linha.querySelectorAll("input, select");
  allInputs.forEach(el => {
    el.addEventListener("input", () => {
      if (el.classList && el.classList.contains("tipoSelect")) {
        const tipo = el.value;
        const valorBaseInput = linha.querySelectorAll('input[type="number"]')[0];
        if (tipo === "Gympass") valorBaseInput.value = 7.34;
        else if (tipo === "TotalPass") valorBaseInput.value = 7.38;
        else if (tipo === "Mensal" && (valorBaseInput.value === "7.34" || valorBaseInput.value === "7.38")) {
          valorBaseInput.value = "";
        }
      }
      if (!suspendSave) salvarDadosDebounced();
      calcularTotal();
    });
  });

  linha.querySelector(".removerBtn").addEventListener("click", (e) => {
    if (!confirm("Remover este aluno?")) return;
    e.target.closest("tr").remove();
    if (!suspendSave) salvarDadosDebounced();
    calcularTotal();
  });

  linha.querySelector(".limparBtn").addEventListener("click", () => {
    if (!confirm("Limpar apenas os quadradinhos desta linha?")) return;
    let checkboxes = linha.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    if (!suspendSave) salvarDadosDebounced();
    calcularTotal();
  });

  if (!isRemote && !suspendSave) {
    salvarDadosDebounced();
    calcularTotal();
  }
}

/* ============================
   CALCULO E EXPORT
   ============================ */
function calcularTotal() {
  let linhas = corpoTabela.querySelectorAll("tr");
  let totalGeral = 0;
  linhas.forEach(linha => {
    let valorBase = Number(linha.querySelectorAll('input[type="number"]')[0].value) || 0;
    let valorExtra = Number(linha.querySelectorAll('input[type="number"]')[1].value) || 0;
    let diasMarcados = linha.querySelectorAll('input[type="checkbox"]:checked').length;
    let totalAluno = (valorBase * diasMarcados) + valorExtra;
    linha.querySelector(".total").innerText = totalAluno.toFixed(2);
    totalGeral += totalAluno;
  });
  document.getElementById("total").innerText = "üíµ Total Final: R$ " + totalGeral.toFixed(2);
}

function exportarExcel() {
  calcularTotal();
  let nomeArquivo = "Planilha_" + (colaboradorAtual || "SemColaborador") + ".xlsx";
  let tabela = document.getElementById("planilha");
  let dados = [];
  tabela.querySelectorAll("tr").forEach(linha => {
    let linhaDados = [];
    linha.querySelectorAll("th, td").forEach(celula => {
      if (celula.querySelector("input[type='text']")) linhaDados.push(celula.querySelector("input").value);
      else if (celula.querySelector("input[type='number']")) linhaDados.push(celula.querySelector("input").value);
      else if (celula.querySelector("select")) linhaDados.push(celula.querySelector("select").value);
      else if (celula.querySelector("input[type='checkbox']")) linhaDados.push(celula.querySelector("input").checked ? "‚úì" : "");
      else linhaDados.push(celula.innerText);
    });
    dados.push(linhaDados);
  });
  let planilha = XLSX.utils.aoa_to_sheet(dados);
  let arquivo = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(arquivo, planilha, colaboradorAtual || "Sheet1");
  XLSX.writeFile(arquivo, nomeArquivo);
}

/* ============================
   SALVAR / DEBOUNCE
   ============================ */
function coletarDadosDaTabela() {
  let alunos = [];
  corpoTabela.querySelectorAll("tr").forEach(linha => {
    let inputs = linha.querySelectorAll("input, select");
    let aluno = {
      nome: inputs[0].value,
      modalidade: inputs[1].value,
      tipo: inputs[2].value,
      valorBase: inputs[3].value,
      valorExtra: inputs[4].value,
      dias: Array.from(inputs).slice(5, 36).map(cb => cb.checked)
    };
    alunos.push(aluno);
  });
  return alunos;
}

function salvarDadosDebounced() {
  if (saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => salvarDados(), 300);
}

async function salvarDados() {
  if (!colaboradorAtual) return;
  if (suspendSave) return;
  const alunos = coletarDadosDaTabela();
  const periodo = document.getElementById("mesInput").value || "";
  try {
    await db.ref("colaboradores/" + colaboradorAtual).set({
      alunos,
      periodoSelecionado: periodo
    });
  } catch (err) {
    console.error("Erro ao salvar no Firebase:", err);
  }
}

/* ============================
   LIMPAR QUADRADINHOS
   ============================ */
function limparQuadradinhos() {
  if (!confirm("Deseja realmente apagar todos os quadradinhos marcados?")) return;
  let checkboxes = corpoTabela.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
  if (!suspendSave) salvarDadosDebounced();
  calcularTotal();
}

/* ============================
   BOOT
   ============================ */
document.getElementById("mesInput").addEventListener("change", () => {
  salvarPeriodo();
  limparQuadradinhos();
});

window.onload = async function() {
  // 1) tenta migrar dados locais para Firebase (uma vez)
  await migrarLocalParaFirebaseSeNecessario();

  // 2) carrega periodo local (fallback)
  await carregarPeriodo();

  // 3) attach global listener (vai popular select e carregar dados do colaborador automaticamente)
  attachGlobalListener();
};
</script>

</body>
</html>
