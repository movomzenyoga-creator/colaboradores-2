<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Realtime</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(120deg,#f3e8ff,#e0f7ff);
  padding: 20px;
}
h1 { text-align:center; color:#4b0082 }
table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:#fff;
}
th,td {
  border:1px solid #d6bcfa;
  padding:5px;
  text-align:center;
}
th {
  background:#6b21a8;
  color:#fff;
}
input,select {
  border:1px solid #a78bfa;
  border-radius:4px;
  padding:4px;
}
button {
  margin-top:10px;
  padding:6px 12px;
  background:#06b6d4;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
button.danger { background:#dc2626 }
.total { font-weight:bold }
</style>
</head>

<body>

<h1>üìã Planilha Realtime</h1>

<label>Colaborador:</label>
<select id="colaboradorSelect"></select>
<button onclick="novoColaborador()">‚ûï Novo</button>
<button class="danger" onclick="removerColaborador()">üóëÔ∏è Remover</button>

<label style="margin-left:15px">M√™s:</label>
<input type="month" id="mesSelect">

<table>
<thead>
<tr id="cabecalho"></tr>
</thead>
<tbody id="corpoTabela"></tbody>
</table>

<button onclick="adicionarAluno()">‚ûï Aluno</button>
<button onclick="limparDias()">üßπ Limpar dias</button>

<p id="total"></p>
<p id="media"></p>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyD9Er27RZlKcFVVwrnWfo2xvWkPUla9JRs",
  databaseURL: "https://colaboradores-5a2a2-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* CABE√áALHO */
cabecalho.innerHTML = `
<th>Aluno</th>
<th>Modalidade</th>
<th>Tipo</th>
<th>Valor Base</th>
<th>Extra</th>
${Array.from({length:31},(_,i)=>`<th>${i+1}</th>`).join("")}
<th>Total</th>
<th>A√ß√µes</th>
`;

/* ESTADO */
let colaboradorAtual = null;
let mesAtual = new Date().toISOString().slice(0,7);
mesSelect.value = mesAtual;

/* COLABORADORES */
function carregarColaboradores(){
  db.ref("colaboradores").once("value").then(snap=>{
    colaboradorSelect.innerHTML="";
    Object.keys(snap.val()||{}).forEach(nome=>{
      let o=document.createElement("option");
      o.value=o.textContent=nome;
      colaboradorSelect.appendChild(o);
    });
    colaboradorAtual = colaboradorSelect.value;
    carregarDados();
  });
}

colaboradorSelect.onchange = ()=>{ colaboradorAtual = colaboradorSelect.value; carregarDados(); };
mesSelect.onchange = ()=>{ mesAtual = mesSelect.value; carregarDados(); };

/* DADOS */
function carregarDados(){
  corpoTabela.innerHTML="";
  if(!colaboradorAtual) return;

  db.ref(`colaboradores/${colaboradorAtual}/ciclos/${mesAtual}/alunos`)
    .once("value")
    .then(snap=>{
      (snap.val()||[]).forEach(a=>adicionarAluno(a,true));
      calcularTotal();
      calcularMedia();
    });
}

/* ALUNO */
function adicionarAluno(data={}, remoto=false){
  let tr=document.createElement("tr");
  tr.innerHTML=`
<td><input class="nome"></td>
<td>Pilates</td>
<td>
  <select class="tipo">
    <option>Mensal</option>
    <option>Gympass</option>
    <option>TotalPass</option>
  </select>
</td>
<td><input type="number" step="0.01" class="base"></td>
<td><input type="number" step="0.01" class="extra"></td>
${"<td><input type='checkbox'></td>".repeat(31)}
<td class="total">0</td>
<td><button onclick="this.closest('tr').remove();salvar()">‚ùå</button></td>
`;
  corpoTabela.appendChild(tr);

  tr.querySelector(".nome").value = data.nome || "";
  tr.querySelector(".tipo").value = data.tipo || "Mensal";
  tr.querySelector(".base").value = data.valorBase || "";
  tr.querySelector(".extra").value = data.valorExtra || "";
  (data.dias||[]).forEach((d,i)=>tr.querySelectorAll("input[type=checkbox]")[i].checked=d);

  /* TIPO ‚Üí VALOR AUTOM√ÅTICO */
  tr.querySelector(".tipo").onchange = e=>{
    const base = tr.querySelector(".base");
    if(e.target.value === "Gympass") base.value = 7.34;
    if(e.target.value === "TotalPass") base.value = 7.38;
    if(e.target.value === "Mensal") base.value = "";
    salvar(); calcularTotal();
  };

  tr.querySelectorAll("input").forEach(i=>{
    i.onchange = ()=>{ salvar(); calcularTotal(); };
  });

  if(!remoto) salvar();
}

/* LIMPAR DIAS */
function limparDias(){
  corpoTabela.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
  salvar();
  calcularTotal();
}

/* SALVAR */
function salvar(){
  if(!colaboradorAtual || !mesAtual) return;

  let alunos=[];
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    alunos.push({
      nome: tr.querySelector(".nome").value,
      modalidade: "Pilates",
      tipo: tr.querySelector(".tipo").value,
      valorBase: tr.querySelector(".base").value,
      valorExtra: tr.querySelector(".extra").value,
      dias: [...tr.querySelectorAll("input[type=checkbox]")].map(c=>c.checked)
    });
  });

  db.ref(`colaboradores/${colaboradorAtual}/ciclos/${mesAtual}/alunos`).set(alunos);
}

/* TOTAL */
function calcularTotal(){
  let totalMes=0;
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    let b=+tr.querySelector(".base").value||0;
    let e=+tr.querySelector(".extra").value||0;
    let d=tr.querySelectorAll("input[type=checkbox]:checked").length;
    let t=(b*d)+e;
    tr.querySelector(".total").innerText=t.toFixed(2);
    totalMes+=t;
  });
  total.innerText="Total do m√™s: R$ "+totalMes.toFixed(2);
}

/* M√âDIA */
function calcularMedia(){
  db.ref(`colaboradores/${colaboradorAtual}/ciclos`)
    .once("value")
    .then(snap=>{
      let soma=0, cont=0;
      snap.forEach(m=>{
        let alunos=m.val().alunos||[];
        let t=alunos.reduce((a,x)=>{
          let d=(x.dias||[]).filter(Boolean).length;
          return a+(+x.valorBase||0)*d+(+x.valorExtra||0);
        },0);
        soma+=t; cont++;
      });
      media.innerText="M√©dia salarial: R$ "+(cont?soma/cont:0).toFixed(2);
    });
}

/* CRUD */
function novoColaborador(){
  let n=prompt("Nome do colaborador:");
  if(!n) return;
  db.ref("colaboradores/"+n).set({});
  carregarColaboradores();
}

function removerColaborador(){
  if(confirm("Remover colaborador?")){
    db.ref("colaboradores/"+colaboradorAtual).remove();
    carregarColaboradores();
  }
}

window.onload = carregarColaboradores;
</script>

</body>
</html>
