<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Realtime por M√™s</title>

<style>
body{font-family:Arial;background:linear-gradient(120deg,#f3e8ff,#e0f7ff);padding:20px}
h1{text-align:center;color:#4b0082}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
th,td{border:1px solid #d6bcfa;padding:5px;text-align:center}
th{background:#6b21a8;color:#fff}
input,select{border:1px solid #a78bfa;border-radius:4px;padding:4px}
button{margin-top:10px;padding:6px 12px;background:#06b6d4;color:#fff;border:none;border-radius:5px;cursor:pointer}
button.danger{background:#dc2626}
.total{font-weight:bold}
.resumo{margin-top:10px;font-weight:bold}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<h1>üìã Planilha por M√™s</h1>

<label>Colaborador:</label>
<select id="colaboradorSelect" onchange="trocarColaborador()"></select>

<label style="margin-left:10px">M√™s:</label>
<input type="month" id="mesSelect" onchange="trocarMes()">

<table>
<thead>
<tr>
  <th>Aluno</th>
  <th>Modalidade</th>
  <th>Tipo</th>
  <th>Valor Base</th>
  <th>Extra</th>
  <script>for(let i=1;i<=31;i++)document.write(`<th>${i}</th>`)</script>
  <th>Total</th>
  <th>A√ß√µes</th>
</tr>
</thead>
<tbody id="corpoTabela"></tbody>
</table>

<button onclick="adicionarAluno()">‚ûï Aluno</button>

<p class="resumo" id="total"></p>
<p class="resumo" id="media"></p>

<script>
const firebaseConfig={
  apiKey:"AIzaSyD9Er27RZlKcFVVwrnWfo2xvWkPUla9JRs",
  authDomain:"colaboradores-5a2a2.firebaseapp.com",
  databaseURL:"https://colaboradores-5a2a2-default-rtdb.firebaseio.com",
  projectId:"colaboradores-5a2a2"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let colaboradorAtual=null;
let cicloAtual=new Date().toISOString().slice(0,7);
let suspendSave=false;

mesSelect.value=cicloAtual;

/* ---------- COLABORADORES ---------- */

function carregarColaboradores(){
  db.ref("colaboradores").on("value",snap=>{
    colaboradorSelect.innerHTML="";
    Object.keys(snap.val()||{}).forEach(n=>{
      let o=document.createElement("option");
      o.value=n;o.textContent=n;
      colaboradorSelect.appendChild(o);
    });
    if(!colaboradorAtual && colaboradorSelect.value){
      colaboradorAtual=colaboradorSelect.value;
      carregarCiclo();
    }
  });
}

function trocarColaborador(){
  colaboradorAtual=colaboradorSelect.value;
  carregarCiclo();
}

function trocarMes(){
  cicloAtual=mesSelect.value;
  carregarCiclo();
}

/* ---------- CICLOS ---------- */

function carregarCiclo(){
  if(!colaboradorAtual||!cicloAtual)return;
  db.ref(`colaboradores/${colaboradorAtual}`).once("value",snap=>{
    let dados=snap.val()||{};

    // MIGRA√á√ÉO AUTOM√ÅTICA
    if(dados.alunos && !dados.ciclos){
      let total=0;
      dados.alunos.forEach(a=>{
        let d=(a.dias||[]).filter(Boolean).length;
        total+=((Number(a.valorBase)||0)*d)+(Number(a.valorExtra)||0);
      });
      db.ref(`colaboradores/${colaboradorAtual}/ciclos/${cicloAtual}`)
        .set({alunos:dados.alunos,totalMes:total});
      db.ref(`colaboradores/${colaboradorAtual}/alunos`).remove();
      return;
    }

    db.ref(`colaboradores/${colaboradorAtual}/ciclos/${cicloAtual}`)
      .on("value",snapC=>{
        suspendSave=true;
        corpoTabela.innerHTML="";
        (snapC.val()?.alunos||[]).forEach(a=>adicionarAluno(a,true));
        calcularTotal();
        calcularMedia();
        setTimeout(()=>suspendSave=false,100);
      });
  });
}

/* ---------- ALUNOS ---------- */

function adicionarAluno(data=null,remoto=false){
  let tr=document.createElement("tr");
  tr.innerHTML=`
<td><input class="nome"></td>
<td>Pilates</td>
<td>
<select class="tipo">
<option>Mensal</option>
<option>Gympass</option>
<option>TotalPass</option>
</select>
</td>
<td><input type="number" class="base"></td>
<td><input type="number" class="extra"></td>
${"<td><input type='checkbox'></td>".repeat(31)}
<td class="total">0</td>
<td><button onclick="this.closest('tr').remove();salvar()">‚ùå</button></td>
`;
  corpoTabela.appendChild(tr);

  if(data){
    tr.querySelector(".nome").value=data.nome||"";
    tr.querySelector(".tipo").value=data.tipo||"Mensal";
    tr.querySelector(".base").value=data.valorBase||"";
    tr.querySelector(".extra").value=data.valorExtra||"";
    data.dias?.forEach((d,i)=>tr.querySelectorAll("input[type=checkbox]")[i].checked=d);
  }

  tr.querySelectorAll("input,select").forEach(e=>{
    e.addEventListener("change",()=>{salvar();calcularTotal()});
  });

  if(!remoto) salvar();
}

/* ---------- SALVAR ---------- */

function salvar(){
  if(!colaboradorAtual||suspendSave)return;
  let alunos=[];
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    alunos.push({
      nome:tr.querySelector(".nome").value,
      modalidade:"Pilates",
      tipo:tr.querySelector(".tipo").value,
      valorBase:tr.querySelector(".base").value,
      valorExtra:tr.querySelector(".extra").value,
      dias:[...tr.querySelectorAll("input[type=checkbox]")].map(c=>c.checked)
    });
  });
  let total=calcularTotal(false);
  db.ref(`colaboradores/${colaboradorAtual}/ciclos/${cicloAtual}`)
    .set({alunos,totalMes:total});
}

/* ---------- TOTAIS ---------- */

function calcularTotal(update=true){
  let total=0;
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    let v=Number(tr.querySelector(".base").value)||0;
    let e=Number(tr.querySelector(".extra").value)||0;
    let d=tr.querySelectorAll("input[type=checkbox]:checked").length;
    let t=(v*d)+e;
    tr.querySelector(".total").innerText=t.toFixed(2);
    total+=t;
  });
  if(update)document.getElementById("total").innerText="Total do m√™s: R$ "+total.toFixed(2);
  return total;
}

function calcularMedia(){
  db.ref(`colaboradores/${colaboradorAtual}/ciclos`).once("value",snap=>{
    let soma=0,cont=0;
    snap.forEach(c=>{
      soma+=Number(c.val().totalMes)||0;
      cont++;
    });
    let media=cont? (soma/cont):0;
    document.getElementById("media").innerText=
      "M√©dia salarial: R$ "+media.toFixed(2);
  });
}

window.onload=carregarColaboradores;
</script>

</body>
</html>
