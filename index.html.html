<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Realtime</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(120deg,#f3e8ff,#e0f7ff);
  padding: 20px;
}
h1 { text-align:center; color:#4b0082 }
.periodo { text-align:center; font-weight:bold; margin-top:5px }
table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:#fff;
}
th,td {
  border:1px solid #d6bcfa;
  padding:5px;
  text-align:center;
}
th {
  background:#6b21a8;
  color:#fff;
}
input,select {
  border:1px solid #a78bfa;
  border-radius:4px;
  padding:4px;
}
button {
  margin-top:10px;
  padding:6px 12px;
  background:#06b6d4;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
button:hover { background:#0891b2 }
.total { font-weight:bold }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<h1>üìã Planilha Realtime</h1>
<div class="periodo">Per√≠odo: dia 5 ao dia 4</div>

<label>Colaborador:</label>
<select id="colaboradorSelect" onchange="trocarColaborador()"></select>
<button onclick="novoColaborador()">‚ûï Novo</button>

<table>
<thead>
<tr>
  <th>Aluno</th>
  <th>Modalidade</th>
  <th>Tipo</th>
  <th>Valor Base</th>
  <th>Extra</th>
  <script>
    for(let i=1;i<=31;i++) document.write(`<th>${i}</th>`)
  </script>
  <th>Total</th>
  <th>A√ß√µes</th>
</tr>
</thead>
<tbody id="corpoTabela"></tbody>
</table>

<button onclick="adicionarAluno()">‚ûï Aluno</button>
<button onclick="limparChecks()">üßπ Limpar quadradinhos</button>

<p id="total"></p>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD9Er27RZlKcFVVwrnWfo2xvWkPUla9JRs",
  authDomain: "colaboradores-5a2a2.firebaseapp.com",
  databaseURL: "https://colaboradores-5a2a2-default-rtdb.firebaseio.com",
  projectId: "colaboradores-5a2a2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let colaboradorAtual = null;
let suspendSave = false;

function carregarColaboradores(){
  db.ref("colaboradores").on("value", snap=>{
    const dados = snap.val()||{};
    colaboradorSelect.innerHTML="";
    Object.keys(dados).forEach(n=>{
      let o=document.createElement("option");
      o.value=n;o.textContent=n;
      colaboradorSelect.appendChild(o);
    });
    if(!colaboradorAtual && colaboradorSelect.value){
      colaboradorAtual = colaboradorSelect.value;
      carregarDados();
    }
  });
}

function trocarColaborador(){
  colaboradorAtual = colaboradorSelect.value;
  carregarDados();
}

function novoColaborador(){
  let nome = prompt("Nome do colaborador:");
  if(!nome) return;
  nome = nome.trim();

  db.ref("colaboradores").once("value", snap=>{
    const dados = snap.val()||{};
    const existente = Object.keys(dados)
      .find(n=>n.toLowerCase()===nome.toLowerCase());

    if(existente){
      colaboradorAtual = existente;
      colaboradorSelect.value = existente;
      carregarDados();
    } else {
      db.ref("colaboradores/"+nome).set({alunos:[]}).then(()=>{
        colaboradorAtual = nome;
        carregarColaboradores();
        setTimeout(()=>{
          colaboradorSelect.value = nome;
          carregarDados();
        },100);
      });
    }
  });
}

function carregarDados(){
  db.ref("colaboradores/"+colaboradorAtual).off();
  db.ref("colaboradores/"+colaboradorAtual).on("value", snap=>{
    suspendSave=true;
    const dados=snap.val()||{};
    corpoTabela.innerHTML="";
    (dados.alunos||[]).forEach(a=>adicionarAluno(a,true));
    calcularTotal();
    setTimeout(()=>suspendSave=false,50);
  });
}

function adicionarAluno(data=null, remoto=false){
  let tr=document.createElement("tr");
  tr.innerHTML=`
<td><input></td>
<td>
  <select>
    <option>Pilates</option>
  </select>
</td>
<td>
  <select class="tipo">
    <option value="Mensal">Mensal</option>
    <option value="Gympass">Gympass</option>
    <option value="TotalPass">TotalPass</option>
  </select>
</td>
<td><input type="number"></td>
<td><input type="number"></td>
${"<td><input type='checkbox'></td>".repeat(31)}
<td class="total">0</td>
<td><button onclick="this.closest('tr').remove();salvar()">‚ùå</button></td>
`;
  corpoTabela.appendChild(tr);

  if(data){
    let i=tr.querySelectorAll("input,select");
    i[0].value=data.nome||"";
    i[2].value=data.tipo||"Mensal";
    i[3].value=data.valorBase||0;
    i[4].value=data.valorExtra||0;
    data.dias?.forEach((d,x)=>i[5+x].checked=d);
  }

  tr.querySelector(".tipo").addEventListener("change",()=>{
    let tipo = tr.querySelector(".tipo").value;
    let valorBase = tr.querySelectorAll("input")[1];

    if(tipo==="Gympass") valorBase.value = 7.34;
    if(tipo==="TotalPass") valorBase.value = 7.38;
    if(tipo==="Mensal") valorBase.value = "";

    salvar(); calcularTotal();
  });

  tr.querySelectorAll("input,select").forEach(e=>{
    e.addEventListener("input",()=>{if(!suspendSave)salvar();calcularTotal()});
  });

  if(!remoto) salvar();
}

function limparChecks(){
  corpoTabela.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
  salvar(); calcularTotal();
}

function salvar(){
  if(!colaboradorAtual) return;
  let alunos=[];
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    let i=tr.querySelectorAll("input,select");
    alunos.push({
      nome:i[0].value,
      modalidade:"Pilates",
      tipo:i[2].value,
      valorBase:i[3].value,
      valorExtra:i[4].value,
      dias:[...i].slice(5,36).map(c=>c.checked)
    });
  });
  db.ref("colaboradores/"+colaboradorAtual).set({alunos});
}

function calcularTotal(){
  let total=0;
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    let v=Number(tr.querySelectorAll("input")[1].value)||0;
    let e=Number(tr.querySelectorAll("input")[2].value)||0;
    let d=tr.querySelectorAll("input[type=checkbox]:checked").length;
    let t=(v*d)+e;
    tr.querySelector(".total").innerText=t.toFixed(2);
    total+=t;
  });
  document.getElementById("total").innerText="Total: R$ "+total.toFixed(2);
}

window.onload=carregarColaboradores;
</script>

</body>
</html>
