<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Planilha Realtime</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial;
  background: linear-gradient(120deg,#f3e8ff,#e0f7ff);
  padding: 20px;
}
table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td {
  border:1px solid #d6bcfa;
  padding:5px;
  text-align:center;
}
th {
  background:#6b21a8;
  color:#fff;
}
button {
  margin:5px;
  padding:6px 12px;
}
.total { font-weight:bold }
</style>
</head>

<body>

<h1>üìã Planilha Realtime</h1>

Colaborador:
<select id="colaboradorSelect"></select>
<button onclick="novoColaborador()">‚ûï Novo</button>
<button onclick="removerColaborador()">üóëÔ∏è Remover</button>

<table>
<thead>
<tr>
<th>Aluno</th>
<th>Modalidade</th>
<th>Tipo</th>
<th>Valor Base</th>
<th>Extra</th>
<script>
for(let i=1;i<=31;i++)document.write(`<th>${i}</th>`);
</script>
<th>Total</th>
<th></th>
</tr>
</thead>
<tbody id="corpoTabela"></tbody>
</table>

<button onclick="adicionarAluno()">‚ûï Aluno</button>

<p id="total"></p>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD9Er27RZlKcFVVwrnWfo2xvWkPUla9JRs",
  databaseURL: "https://colaboradores-5a2a2-default-rtdb.firebaseio.com"
});
const db = firebase.database();

let colaboradorAtual = null;

/* COLABORADORES */
function carregarColaboradores(){
  db.ref("colaboradores").once("value").then(s=>{
    colaboradorSelect.innerHTML="";
    Object.keys(s.val()||{}).forEach(n=>{
      let o=document.createElement("option");
      o.value=o.textContent=n;
      colaboradorSelect.appendChild(o);
    });
    colaboradorAtual=colaboradorSelect.value;
    carregarDados();
  });
}

colaboradorSelect.onchange=()=>{
  colaboradorAtual=colaboradorSelect.value;
  carregarDados();
};

/* DADOS (FORMATO ANTIGO) */
function carregarDados(){
  corpoTabela.innerHTML="";
  if(!colaboradorAtual)return;

  db.ref("colaboradores/"+colaboradorAtual+"/alunos")
    .once("value").then(snap=>{
      const alunosObj = snap.val() || {};
      Object.values(alunosObj).forEach(a=>{
        adicionarAluno(a,true);
      });
      calcularTotal();
    });
}

/* ALUNO */
function adicionarAluno(a={},remoto=false){
  let tr=document.createElement("tr");
  tr.innerHTML=`
<td><input class="nome"></td>
<td>Pilates</td>
<td><select class="tipo"><option>Mensal</option><option>Gympass</option><option>TotalPass</option></select></td>
<td><input class="base"></td>
<td><input class="extra"></td>
${"<td><input type='checkbox'></td>".repeat(31)}
<td class="total">0</td>
<td><button onclick="this.closest('tr').remove()">‚ùå</button></td>
`;
  corpoTabela.appendChild(tr);

  tr.querySelector(".nome").value=a.nome||"";
  tr.querySelector(".tipo").value=a.tipo||"Mensal";
  tr.querySelector(".base").value=a.valorBase||"";
  tr.querySelector(".extra").value=a.valorExtra||"";
  a.dias?.forEach((d,i)=>tr.querySelectorAll("input[type=checkbox]")[i].checked=d);

  tr.querySelectorAll("input,select").forEach(e=>
    e.onchange=calcularTotal
  );
}

/* TOTAL */
function calcularTotal(){
  let t=0;
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    let b=+tr.querySelector(".base").value||0;
    let e=+tr.querySelector(".extra").value||0;
    let d=tr.querySelectorAll("input[type=checkbox]:checked").length;
    let v=(b*d)+e;
    tr.querySelector(".total").innerText=v.toFixed(2);
    t+=v;
  });
  total.innerText="Total: R$ "+t.toFixed(2);
}

function novoColaborador(){
  let n=prompt("Nome:");
  if(!n)return;
  db.ref("colaboradores/"+n).set({ alunos:{} });
  carregarColaboradores();
}

function removerColaborador(){
  if(confirm("Remover colaborador?"))
    db.ref("colaboradores/"+colaboradorAtual).remove();
  carregarColaboradores();
}

window.onload=carregarColaboradores;
</script>
</body>
</html>


