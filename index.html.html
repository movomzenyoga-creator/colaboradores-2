<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Planilha Realtime</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body{font-family:Arial;background:#f3e8ff;padding:20px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:5px;text-align:center}
th{background:#6b21a8;color:#fff}
button{margin:5px;padding:6px 12px}
.total{font-weight:bold}
</style>
</head>

<body>

<h2>üìã Planilha Realtime</h2>

Colaborador:
<select id="colaboradorSelect"></select>
<button onclick="novoColaborador()">‚ûï</button>
<button onclick="removerColaborador()">üóëÔ∏è</button>

M√™s:
<input type="month" id="mesSelect">

<table>
<thead>
<tr>
<th>Aluno</th><th>Tipo</th><th>Base</th><th>Extra</th>
<script>for(let i=1;i<=31;i++)document.write(`<th>${i}</th>`)</script>
<th>Total</th><th></th>
</tr>
</thead>
<tbody id="corpoTabela"></tbody>
</table>

<button onclick="adicionarAluno()">‚ûï Aluno</button>

<p id="total"></p>
<p id="media"></p>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyD9Er27RZlKcFVVwrnWfo2xvWkPUla9JRs",
  databaseURL:"https://colaboradores-5a2a2-default-rtdb.firebaseio.com"
});
const db=firebase.database();

/* ESTADO */
let colaboradorAtual=null;
let cicloAtual=new Date().toISOString().slice(0,7);
mesSelect.value=cicloAtual;

/* COLABORADORES */
async function carregarColaboradores(){
  const s=await db.ref("colaboradores").once("value");
  colaboradorSelect.innerHTML="";
  Object.keys(s.val()||{}).forEach(n=>{
    let o=document.createElement("option");
    o.value=o.textContent=n;
    colaboradorSelect.appendChild(o);
  });
  colaboradorAtual=colaboradorSelect.value;
  carregarDados();
}

colaboradorSelect.onchange=()=>{
  colaboradorAtual=colaboradorSelect.value;
  carregarDados();
};

mesSelect.onchange=()=>{
  cicloAtual=mesSelect.value;
  carregarDados();
};

/* DADOS */
async function carregarDados(){
  corpoTabela.innerHTML="";
  const snap=await db.ref("colaboradores/"+colaboradorAtual).once("value");
  const d=snap.val()||{};

  /* üî¥ RECUPERA DADOS ANTIGOS */
  let alunos=[];
  if(d.alunos){
    alunos=d.alunos.map(a=>({
      nome:a.nome,
      tipo:a.tipo,
      base:a.valorBase,
      extra:a.valorExtra,
      dias:a.dias||[]
    }));
  }
  /* NOVO FORMATO */
  else if(d.ciclos?.[cicloAtual]){
    alunos=d.ciclos[cicloAtual].registros;
  }

  alunos.forEach(a=>adicionarAluno(a,true));
  calcularTotal();
  calcularMedia();
}

/* ALUNO */
function adicionarAluno(a={},remoto=false){
  let tr=document.createElement("tr");
  tr.innerHTML=`
<td><input class="nome"></td>
<td><select class="tipo"><option>Mensal</option></select></td>
<td><input class="base"></td>
<td><input class="extra"></td>
${"<td><input type='checkbox'></td>".repeat(31)}
<td class="total">0</td>
<td><button onclick="this.closest('tr').remove();salvar()">‚ùå</button></td>
`;
  corpoTabela.appendChild(tr);

  tr.querySelector(".nome").value=a.nome||"";
  tr.querySelector(".tipo").value=a.tipo||"Mensal";
  tr.querySelector(".base").value=a.base||"";
  tr.querySelector(".extra").value=a.extra||"";
  a.dias?.forEach((d,i)=>tr.querySelectorAll("input[type=checkbox]")[i].checked=d);

  tr.querySelectorAll("input,select").forEach(e=>e.onchange=()=>{salvar();calcularTotal();});
}

/* SALVAR (novo formato) */
function salvar(){
  let registros=[];
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    registros.push({
      nome:tr.querySelector(".nome").value,
      tipo:"Mensal",
      valorBase:tr.querySelector(".base").value,
      valorExtra:tr.querySelector(".extra").value,
      dias:[...tr.querySelectorAll("input[type=checkbox]")].map(c=>c.checked)
    });
  });

  const totalMes=calcularTotal(false);
  db.ref(`colaboradores/${colaboradorAtual}/ciclos/${cicloAtual}`)
    .set({ registros,totalMes });
}

/* TOTAIS */
function calcularTotal(show=true){
  let t=0;
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    let b=+tr.querySelector(".base").value||0;
    let e=+tr.querySelector(".extra").value||0;
    let d=tr.querySelectorAll("input[type=checkbox]:checked").length;
    let v=(b*d)+e;
    tr.querySelector(".total").innerText=v.toFixed(2);
    t+=v;
  });
  if(show) total.innerText="Total do m√™s: R$ "+t.toFixed(2);
  return t;
}

async function calcularMedia(){
  const s=await db.ref(`colaboradores/${colaboradorAtual}/ciclos`).once("value");
  let soma=0,c=0;
  s.forEach(m=>{soma+=+m.val().totalMes||0;c++;});
  media.innerText="M√©dia salarial: R$ "+(c?soma/c:0).toFixed(2);
}

function novoColaborador(){
  let n=prompt("Nome:");
  if(!n)return;
  db.ref("colaboradores/"+n).set({});
  carregarColaboradores();
}
function removerColaborador(){
  if(confirm("Remover?"))
    db.ref("colaboradores/"+colaboradorAtual).remove();
  carregarColaboradores();
}

window.onload=carregarColaboradores;
</script>
</body>
</html>

