<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Realtime</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(120deg,#f3e8ff,#e0f7ff);
  padding: 20px;
}
h1 { text-align:center; color:#4b0082 }
table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:#fff;
}
th,td {
  border:1px solid #d6bcfa;
  padding:5px;
  text-align:center;
}
th {
  background:#6b21a8;
  color:#fff;
}
input,select {
  border:1px solid #a78bfa;
  border-radius:4px;
  padding:4px;
}
button {
  margin-top:10px;
  padding:6px 12px;
  background:#06b6d4;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
button.danger { background:#dc2626 }
button:hover { background:#0891b2 }
.total { font-weight:bold }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<h1>ğŸ“‹ Planilha Realtime</h1>

<label>Colaborador:</label>
<select id="colaboradorSelect" onchange="trocarColaborador()"></select>
<button onclick="novoColaborador()">â• Novo</button>
<button class="danger" onclick="removerColaborador()">ğŸ—‘ï¸ Remover</button>

<label style="margin-left:20px;">MÃªs:</label>
<select id="mesSelect" onchange="trocarMes()"></select>
<button onclick="novoMes()">ğŸ“† Novo mÃªs</button>

<table>
<thead>
<tr>
  <th>Aluno</th>
  <th>Modalidade</th>
  <th>Tipo</th>
  <th>Valor Base</th>
  <th>Extra</th>
  <script>
    for(let i=1;i<=31;i++) document.write(`<th>${i}</th>`)
  </script>
  <th>Total</th>
  <th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="corpoTabela"></tbody>
</table>

<button onclick="adicionarAluno()">â• Aluno</button>
<button onclick="limparChecks()">ğŸ§¹ Limpar quadradinhos</button>

<p id="total"></p>
<p id="media"></p>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyD9Er27RZlKcFVVwrnWfo2xvWkPUla9JRs",
  authDomain: "colaboradores-5a2a2.firebaseapp.com",
  databaseURL: "https://colaboradores-5a2a2-default-rtdb.firebaseio.com",
  projectId: "colaboradores-5a2a2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let colaboradorAtual = null;
let mesAtual = null;
let suspendSave = false;

/* ================= COLABORADORES ================= */

function carregarColaboradores(){
  db.ref("colaboradores").on("value", snap=>{
    const dados = snap.val() || {};
    colaboradorSelect.innerHTML="";
    Object.keys(dados).forEach(nome=>{
      let o=document.createElement("option");
      o.value=nome;
      o.textContent=nome;
      colaboradorSelect.appendChild(o);
    });
    if(!colaboradorAtual && colaboradorSelect.value){
      colaboradorAtual = colaboradorSelect.value;
      carregarMeses();
    }
  });
}

function trocarColaborador(){
  colaboradorAtual = colaboradorSelect.value;
  mesAtual = null;
  carregarMeses();
}

function novoColaborador(){
  let nome = prompt("Nome do colaborador:");
  if(!nome) return;
  db.ref("colaboradores/"+nome).set({ meses:{} });
  colaboradorAtual = nome;
}

function removerColaborador(){
  if(!confirm("Remover colaborador?")) return;
  db.ref("colaboradores/"+colaboradorAtual).remove();
  colaboradorAtual = null;
  corpoTabela.innerHTML="";
  mesSelect.innerHTML="";
  document.getElementById("total").innerText="";
  document.getElementById("media").innerText="";
}

/* ================= MESES ================= */

function carregarMeses(){
  if(!colaboradorAtual) return;

  db.ref(`colaboradores/${colaboradorAtual}/meses`).off();
  db.ref(`colaboradores/${colaboradorAtual}/meses`).on("value", snap=>{
    const meses = snap.val() || {};
    mesSelect.innerHTML="";

    Object.keys(meses).sort().forEach(m=>{
      let o=document.createElement("option");
      o.value=m;
      o.textContent=m;
      mesSelect.appendChild(o);
    });

    if(!mesAtual && mesSelect.value){
      mesAtual = mesSelect.value;
      carregarDados();
    }

    calcularMedia();
  });
}

function trocarMes(){
  mesAtual = mesSelect.value;
  carregarDados();
}

function novoMes(){
  let mes = prompt("MÃªs (ex: 2025-02):");
  if(!mes || !colaboradorAtual) return;

  const refMeses = db.ref(`colaboradores/${colaboradorAtual}/meses`);

  refMeses.once("value", snap=>{
    const meses = snap.val() || {};
    const lista = Object.keys(meses).sort();

    let alunosCopiados = [];

    if(lista.length){
      const ultimoMes = lista[lista.length - 1];
      const alunosAntigos = meses[ultimoMes].alunos || [];

      alunosCopiados = alunosAntigos.map(a => ({
        nome: a.nome || "",
        tipo: a.tipo || "Mensal",
        valorBase: a.valorBase || "",
        valorExtra: a.valorExtra || "",
        dias: Array(31).fill(false)
      }));
    }

    refMeses.child(mes).set({ alunos: alunosCopiados });
    mesAtual = mes;
  });
}

/* ================= DADOS ================= */

function carregarDados(){
  if(!colaboradorAtual || !mesAtual) return;

  db.ref(`colaboradores/${colaboradorAtual}/meses/${mesAtual}`).off();
  db.ref(`colaboradores/${colaboradorAtual}/meses/${mesAtual}`).on("value", snap=>{
    suspendSave = true;
    corpoTabela.innerHTML="";
    (snap.val()?.alunos || []).forEach(a=>adicionarAluno(a,true));
    calcularTotal();
    suspendSave = false;
  });
}

function adicionarAluno(data=null, remoto=false){
  let tr=document.createElement("tr");
  tr.innerHTML=`
<td><input class="nome"></td>
<td>Pilates</td>
<td>
  <select class="tipo">
    <option>Mensal</option>
    <option>Gympass</option>
    <option>TotalPass</option>
  </select>
</td>
<td><input type="number" class="base"></td>
<td><input type="number" class="extra"></td>
${"<td><input type='checkbox'></td>".repeat(31)}
<td class="total">0</td>
<td><button onclick="this.closest('tr').remove();salvar()">âŒ</button></td>
`;
  corpoTabela.appendChild(tr);

  if(data){
    tr.querySelector(".nome").value = data.nome || "";
    tr.querySelector(".tipo").value = data.tipo || "Mensal";
    tr.querySelector(".base").value = data.valorBase || "";
    tr.querySelector(".extra").value = data.valorExtra || "";
    data.dias?.forEach((d,i)=>tr.querySelectorAll("input[type=checkbox]")[i].checked=d);
  }

  tr.querySelectorAll("input,select").forEach(e=>{
    e.addEventListener("change",()=>{ salvar(); calcularTotal(); });
  });

  if(!remoto) salvar();
}

/* ================= FUNÃ‡Ã•ES PEDIDAS ================= */

function limparChecks(){
  if(!colaboradorAtual || !mesAtual) return;
  document.querySelectorAll("#corpoTabela input[type=checkbox]")
    .forEach(c => c.checked = false);
  salvar();
  calcularTotal();
}

/* ================= SALVAR / TOTAIS ================= */

function salvar(){
  if(suspendSave) return;

  let alunos=[];
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    alunos.push({
      nome: tr.querySelector(".nome").value,
      tipo: tr.querySelector(".tipo").value,
      valorBase: tr.querySelector(".base").value,
      valorExtra: tr.querySelector(".extra").value,
      dias: [...tr.querySelectorAll("input[type=checkbox]")].map(c=>c.checked)
    });
  });

  db.ref(`colaboradores/${colaboradorAtual}/meses/${mesAtual}`)
    .set({ alunos });
}

function calcularTotal(){
  let total=0;
  corpoTabela.querySelectorAll("tr").forEach(tr=>{
    let base=Number(tr.querySelector(".base").value)||0;
    let extra=Number(tr.querySelector(".extra").value)||0;
    let dias=tr.querySelectorAll("input[type=checkbox]:checked").length;
    let t=(base*dias)+extra;
    tr.querySelector(".total").innerText=t.toFixed(2);
    total+=t;
  });
  document.getElementById("total").innerText =
    "Total do mÃªs: R$ " + total.toFixed(2);
}

function calcularMedia(){
  db.ref(`colaboradores/${colaboradorAtual}/meses`).once("value", snap=>{
    let soma=0, qtd=0;

    Object.values(snap.val()||{}).forEach(m=>{
      let totalMes=0;
      (m.alunos||[]).forEach(a=>{
        let dias=(a.dias||[]).filter(d=>d).length;
        totalMes += (Number(a.valorBase)||0)*dias +
                    (Number(a.valorExtra)||0);
      });
      soma+=totalMes;
      qtd++;
    });

    document.getElementById("media").innerText =
      qtd ? "MÃ©dia salarial: R$ " + (soma/qtd).toFixed(2) : "";
  });
}

window.onload = carregarColaboradores;
</script>

</body>
</html>


</body>
</html>



